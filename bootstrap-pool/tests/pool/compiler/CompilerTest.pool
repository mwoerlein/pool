/*[meta]
mimetype = text/x-pool
author = Marc Woerlein <marc.woerlein@gmx.de>
version = 0.1.0
*/
namespace pool::compiler;

use sys::core::anycollection::AnyIterator;
use sys::log::NullLogger;
use pool::storage::Mimetype;

class CompilerTest extends test::TestCase {

    [] runAll() {
        this.testSimpleClass();
    }
    
    [int] testSimpleClass() {
        TestStorage t = this.newTestStorage("testSimpleClass");
        
        t.in("my::simple::Sample", Mimetype:POOL_SRC)
            .line("namespace my::simple;")
            .line("class Sample {")
            .line("")
            .line("    [int] one() { return 1; }")
            .line("    [int] two(__any__ obj) {")
            .line("        return '\\n';")
            .line("    }")
            .line("")
            .line("    [int] three(__any__ obj, cstring obj2) {")
            .line("        //return two(obj);")
            .line("        return 0x80000000;")
            .line("    }")
            .line("}")
        ;
        
        t.expect("my::simple::Sample", Mimetype:POOL_SRC)
            .line("namespace my::simple;")
            .line("")
            .line("")
            .line("class Sample {")
            .line("    ")
            .line("    // methods")
            .line("    [int] one() {")
            .line("        return 1;")
            .line("    }")
            .line("    ")
            .line("    [int] two(__any__ obj) {")
            .line("        return 10;")
            .line("    }")
            .line("    ")
            .line("    [int] three(__any__ obj, cstring obj2) {")
            .line("        return -2147483648;")
            .line("    }")
            .line("    ")
            .line("}")
        ;
        
        t.prepare("my::simple::Sample");
        
        return this.runTest(t);
    }

    [TestStorage] newTestStorage(cstring name) {
        this.start(name);
        TestStorage storage = this.rt().createInstance(TestStorage:CLASSNAME);
        return storage.setName(name);
    }
    
    [int] runTest(TestStorage storage) {
        NullLogger l = this.rt().createInstance(NullLogger:CLASSNAME);
        Compiler c = this.rt().createInstance(Compiler:CLASSNAME);
        c.initLogger(l.logger())
            .addClassPath(storage.poolStorage())
            .setPrettyOutput(storage.poolStorage())
        ;
        if (c.hasErrors()) { return this.fail("Compiler initialization"); }
        
        {
            AnyIterator it = storage.prepares();
            while (it.hasNext()) { c.prepare(it.next()); }
            it.destroy();
        }
        if (c.hasErrors()) { return this.fail("Compiler preparation"); }
        
        c.compilePrepared();
        if (c.hasErrors()) { return this.fail("Compiler compilation"); }
        
        if (!storage.validateExpected()) { return this.fail("Pretty validation"); }

        c.destroy();
        l.destroy();
        return this.success();
    }

}
