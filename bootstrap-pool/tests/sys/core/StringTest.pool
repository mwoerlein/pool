/*[meta]
mimetype = text/x-pool
author = Marc Woerlein <marc.woerlein@gmx.de>
version = 0.1.0
*/
namespace sys::core;

use sys::stream::IStream;
use sys::stream::OStream;

class StringTest extends test::TestCase {

    [] runAll() {
        this.testInitializationClearAndLength();
        this.testHashAndEquals();
        this.testComparable();
        this.testConversions();
        this.testIStream();
        this.testOStream();
        this.testPrintToStream();
    }
    
    [int] testInitializationClearAndLength() {
        this.start("testInitializationClearAndLength");
        
        String s1 = this.rt().createInstance(String:CLASSNAME);
        if (s1.length() != 0) { return this.fail("Create empty String"); }
        
        s1.assignCString("0123456789");
        if (s1.length() != 10) { return this.fail("Assign cstring"); }
        
        String s2 = this.rt().createInstance(String:CLASSNAME);
        s2.assignString(s1);
        if (s2.length() != 10) { return this.fail("Assign String"); }
        
        s1.clear();
        if (s1.length() != 0) { return this.fail("Clear String"); }
        
        s2.destroy();
        s1.destroy();
        return this.success();
    }
    
    [int] testHashAndEquals() {
        this.start("testHashAndEquals");
        
        String s1 = this.rt().createInstance(String:CLASSNAME); s1.assignCString("string");
        String s2 = this.rt().createInstance(String:CLASSNAME); s2.assignCString("string");
        String s3 = this.rt().createInstance(String:CLASSNAME); s3.assignCString("other string");
        
        if (s1.hash() != s1.hash()) { return this.fail("Hash value is not constant"); }
        if (s1.hash() != s2.hash()) { return this.fail("Hash value of Strings differs for same cstring values"); }
        if (s1.hash() == s3.hash()) { return this.fail("Hash value of Strings is identical for different cstring values"); }
        
        if (!s1.equals(s1)) { return this.fail("Identity check"); }
        if (!s1.equals(s2)) { return this.fail("Strings with same cstring value are not equal"); }
        if (!s1.cequals("string")) { return this.fail("String do not cequals with same cstring"); }
        if (s1.equals(s3)) { return this.fail("Strings with different cstring value are equal"); }
        if (s1.equals(this)) { return this.fail("String is equal to non-String"); }
        
        s3.destroy();
        s2.destroy();
        s1.destroy();
        return this.success();
    }
    
    [int] testComparable() {
        this.start("testComparable");
        
        String s1 = this.rt().createInstance(String:CLASSNAME);
        String s2 = this.rt().createInstance(String:CLASSNAME); s2.assignCString("ABC");
        String s3 = this.rt().createInstance(String:CLASSNAME); s3.assignCString("ABCDE");
        String s4 = this.rt().createInstance(String:CLASSNAME); s4.assignCString("ABCDE");
        String s5 = this.rt().createInstance(String:CLASSNAME); s5.assignCString("BCD");
        String s6 = this.rt().createInstance(String:CLASSNAME); s6.assignCString("b");
        String s7 = this.rt().createInstance(String:CLASSNAME);
        
        if (s1.compareString(s2) == 0) { return this.fail("Test '' != 'ABC'"); }
        if (s1.compareString(s3) >= 0) { return this.fail("Test '' <  'ABCDE'"); }
        if (s1.compareString(s6) >  0) { return this.fail("Test '' <= 'b'"); }
        if (s2.compareString(s3) >= 0) { return this.fail("Test 'ABC' <  'ABCDE'"); }
        if (s2.compareString(s5) >  0) { return this.fail("Test 'ABC' <= 'BCD'"); }
        if (s3.compareString(s3) >  0) { return this.fail("Test 'ABCDE' <= 'ABCDE' (identity)"); }
        if (s3.compareString(s4) >  0) { return this.fail("Test 'ABCDE' <= 'ABCDE' (different Strings)"); }
        if (s3.compareString(s3) != 0) { return this.fail("Test 'ABCDE' == 'ABCDE' (identity)"); }
        if (s3.compareString(s4) != 0) { return this.fail("Test 'ABCDE' == 'ABCDE' (different Strings)"); }
        if (s3.compareString(s3) <  0) { return this.fail("Test 'ABCDE' >= 'ABCDE' (identity)"); }
        if (s3.compareString(s4) <  0) { return this.fail("Test 'ABCDE' >= 'ABCDE' (different Strings)"); }
        if (s6.compareString(s2) <= 0) { return this.fail("Test 'a' >  'ABC'"); }
        if (s6.compareString(s5) <  0) { return this.fail("Test 'a' >= 'BCD'"); }
        if (s6.compareString(s3) == 0) { return this.fail("Test 'a' != 'ABCDE'"); }
        if (s1.compareString(s1) != 0) { return this.fail("Test '' == '' (identity)"); }
        if (s1.compareString(s7) != 0) { return this.fail("Test '' == '' (different Strings)"); }
        
        if (s1.compareCString("ABCDE") == 0) { return this.fail("Test '' != 'ABCDE' (cstring)"); }
        if (s3.compareCString("ABCDE") != 0) { return this.fail("Test 'ABCDE' == 'ABCDE' (cstring)"); }
        if (s2.compareCString("ABCDE") >= 0) { return this.fail("Test 'ABC' <  'ABCDE' (cstring)"); }
        if (s2.compareCString("ABCDE") >  0) { return this.fail("Test 'ABC' <= 'ABCDE' (cstring)"); }
        if (s5.compareCString("ABCDE") <= 0) { return this.fail("Test 'BCD' >  'ABCDE' (cstring)"); }
        if (s5.compareCString("ABCDE") <  0) { return this.fail("Test 'BCD' >= 'ABCDE' (cstring)"); }
        
        if (s2.compareString(s3)     != -'D') { return this.fail("Invalid distance from 'ABC' to 'ABCDE'"); }
        if (s5.compareCString("ABC") != 1   ) { return this.fail("Invalid distance from 'BCD' to 'ABC'"); }
        if (s5.compareCString("BCD") != 0   ) { return this.fail("Invalid distance from 'BCD' to 'BCD'"); }
        if (s6.compareString(s3)  != 'b'-'A') { return this.fail("Invalid distance from 'b' to 'ABCDE'"); }
        
        s7.destroy();
        s6.destroy();
        s5.destroy();
        s4.destroy();
        s3.destroy();
        s2.destroy();
        s1.destroy();
        return this.success();
    }
    
    [int] testConversions() {
        this.start("testConversions");
        
        return this.skip();
    }
    
    [int] testIStream() {
        this.start("testIStream");
        { // test empty string
            String testString = this.rt().createInstance(String:CLASSNAME);
            IStream testStream = testString.toIStream();
            
            if (!testStream.isEmpty()) { return this.fail("Empty string should have empty stream"); }
            if (testStream.readChar() != 0) { return this.fail("Empty stream do not return 0"); }
            
            testStream.destroy();
            testString.destroy();
        }
        { // test filled string
            String testString = this.rt().createInstance(String:CLASSNAME); testString.assignCString("test");
            IStream testStream = testString.toIStream();
            
            if (testStream.isEmpty()) { return this.fail("Stream is empty after creation"); }
            if (testStream.readChar() != 't') { return this.fail("First char in steam is not 't'"); }
            
            if (testStream.isEmpty()) { return this.fail("Stream is empty after first char"); }
            if (testStream.readChar() != 'e') { return this.fail("Second char in steam is not 'e'"); }
            
            if (testStream.isEmpty()) { return this.fail("Stream is empty after second char"); }
            if (testStream.readChar() != 's') { return this.fail("Third char in steam is not 's'"); }
            
            if (testStream.isEmpty()) { return this.fail("Stream is empty after third char"); }
            if (testStream.readChar() != 't') { return this.fail("Forth char in steam is not 't'"); }
            
            if (!testStream.isEmpty()) { return this.fail("Stream is not empty after forth char"); }
            if (testStream.readChar() != 0) { return this.fail("Empty stream do not return 0"); }
            
            testStream.destroy();
            testString.destroy();
        }
        
        return this.success();
    }
    
    [int] testOStream() {
        this.start("testOStream");
        
        Boolean b = this.rt().createInstance(Boolean:CLASSNAME); b.assignBool(false);
        Character c = this.rt().createInstance(Character:CLASSNAME); c.assignChar('\n');
        String s = this.rt().createInstance(String:CLASSNAME); s.assignCString("text");
        Integer i = this.rt().createInstance(Integer:CLASSNAME);
        
        String testString = this.rt().createInstance(String:CLASSNAME);
        
        testString.printCString("ABC ").printInt(1).printChar(' ').print(null).printNewline();
        if (!testString.cequals("ABC 1 NULL\n")) { return this.fail("String do not prints natives"); }
        
        testString.clear();
        IStream istream = s.toIStream();
        testString.print(i).printChar(' ').print(s).print(c).print(istream).printCString(" ").print(b);
        istream.destroy();
        if (!testString.cequals("0 text\ntext false")) { return this.fail("String do not prints Char, String, Integer, IStream, and Bool"); }
    
        i.destroy();
        s.destroy();
        c.destroy();
        b.destroy();
        testString.destroy();
        
        return this.success();
    }
    
    [int] testPrintToStream() {
        this.start("testPrintToStream");
        
        String s = this.rt().createInstance(String:CLASSNAME);
        String stream = this.rt().createInstance(String:CLASSNAME);
        s.assignCString("Hello");
        s.printToStream(stream.ostream());
        if (!stream.cequals("Hello")) { return this.fail("Invalid value printed for 'Hello'"); }
        
        s.assignCString(" world!");
        s.printToStream(stream.ostream());
        if (!stream.cequals("Hello world!")) { return this.fail("Invalid value printed for ' world!'"); }
        
        s.assignCString("Some \"Text\"\twith escaped '\\' chars \n");
        stream.clear();
        s.escapeToStream(stream.ostream());
        if (!stream.cequals("\"Some \\\"Text\\\"\\twith escaped '\\\\' chars \\n\"")) { return this.fail("Invalid escaped string"); }
        
        stream.destroy();
        s.destroy();
        return this.success();
    }
}
